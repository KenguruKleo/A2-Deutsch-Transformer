# Push exported model to Hugging Face Hub.
# Requires repository secret: HF_TOKEN (with write access to the repo).
# Expects model_final.pth and config.yaml in the repo (commit them or ensure they exist on the branch).
name: Push model to Hugging Face

on:
  push:
    branches: [main]
    paths:
      - 'model_final.pth'
      - 'config.yaml'
      - 'src/export_hf.py'
      - 'src/model/**'
      - 'src/tokenizer/**'
      - 'hf_export/**'
      - '.github/workflows/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  push-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for model
        id: model
        run: echo "exists=$([ -f model_final.pth ] && echo true || echo false)" >> "$GITHUB_OUTPUT"

      - name: Skip (no model)
        if: steps.model.outputs.exists != 'true'
        run: echo "::notice::model_final.pth not in repo — export and push skipped. Commit the model to push to HF."

      - name: Set up Python
        if: steps.model.outputs.exists == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.model.outputs.exists == 'true'
        run: |
          pip install torch pyyaml safetensors huggingface_hub

      - name: Export to HF bundle
        if: steps.model.outputs.exists == 'true'
        run: python src/export_hf.py

      - name: Push to Hugging Face Hub
        if: steps.model.outputs.exists == 'true'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HG_TOKEN: ${{ secrets.HG_TOKEN }}
        run: |
          TOKEN="${HF_TOKEN:-$HG_TOKEN}"
          if [ -z "$TOKEN" ]; then
            echo "::warning::Add HF_TOKEN or HG_TOKEN in Settings → Secrets and Actions."
            exit 0
          fi
          export TOKEN
          pip install huggingface_hub -q
          python scripts/upload_to_hf.py
