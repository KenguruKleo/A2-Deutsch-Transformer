# Push committed hf_export/ to Hugging Face Hub, then restart the demo Space.
# Export is done locally by pre-commit (scripts/export_hf_precommit.sh).
# Requires repository secret: HF_TOKEN or HG_TOKEN (write token).
name: Push model to Hugging Face

on:
  push:
    branches: [main]
    paths:
      - 'hf_export/**'
      - '.github/workflows/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  push-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for hf_export
        id: check
        run: |
          if [ -d hf_export ] && [ -n "$(ls -A hf_export 2>/dev/null | head -1)" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip (no hf_export)
        if: steps.check.outputs.exists != 'true'
        run: echo "::notice::hf_export/ missing or empty — push skipped. Run pre-commit locally (or python src/export_hf.py) and commit."

      - name: Set up Python
        if: steps.check.outputs.exists == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Push to Hugging Face Hub
        if: steps.check.outputs.exists == 'true'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HG_TOKEN: ${{ secrets.HG_TOKEN }}
        run: |
          TOKEN="${HF_TOKEN:-$HG_TOKEN}"
          if [ -z "$TOKEN" ]; then
            echo "::error::Add HF_TOKEN or HG_TOKEN in Settings → Secrets and Actions (write token from https://huggingface.co/settings/tokens)"
            exit 1
          fi
          export TOKEN
          pip install huggingface_hub -q
          python scripts/upload_to_hf.py

      - name: Restart Space (deutsch-a2-tutor)
        if: steps.check.outputs.exists == 'true'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HG_TOKEN: ${{ secrets.HG_TOKEN }}
        run: |
          TOKEN="${HF_TOKEN:-$HG_TOKEN}"
          if [ -n "$TOKEN" ]; then
            pip install huggingface_hub -q
            python -c "from huggingface_hub import HfApi; import os; api = HfApi(token=os.environ.get('HF_TOKEN') or os.environ.get('HG_TOKEN')); api.restart_space(repo_id='kengurukleo/deutsch-a2-tutor'); print('Space restart requested.')"
          else
            echo "::notice::Skipping Space restart (no token)."
          fi
